name: Network Perf Experiment

on:
  workflow_dispatch:

jobs:
  run-experiments:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0

    - name: Terraform Init & Apply
      working-directory: terraform
      run: |
        terraform init
        terraform apply -auto-approve

    - name: Fetch outputs
      id: tf
      working-directory: terraform
      run: |
        SERVER_IP=$(terraform output -raw server_ip)
        S3_BUCKET_NAME=$(terraform output -raw s3_bucket_name)
        echo "SERVER_IP=$SERVER_IP" >> $GITHUB_ENV
        echo "S3_BUCKET_NAME=$S3_BUCKET_NAME" >> $GITHUB_ENV

    - name: Prep Server
      run: |
        aws ssm send-command \
          --targets "Key=tag:Name,Values=network-test-server" \
          --document-name "AWS-RunShellScript" \
          --parameters commands="bash /home/ec2-user/scripts/server_prep.sh"

    - name: Start Receiver Agent
      run: |
        aws ssm send-command \
          --targets "Key=tag:Name,Values=network-test-client-1" \
          --document-name "AWS-RunShellScript" \
          --parameters commands="nohup bash /home/ec2-user/scripts/receiver_agent.sh $SERVER_IP &"

    - name: Run Experiments
      run: |
        aws ssm send-command \
          --targets "Key=tag:Name,Values=network-test-client-1" \
          --document-name "AWS-RunShellScript" \
          --parameters commands="S3_BUCKET=${S3_BUCKET_NAME} bash /home/ec2-user/scripts/run_experiments.sh $SERVER_IP"

    - name: Download results from S3
      run: |
        mkdir -p results
        aws s3 cp "s3://${S3_BUCKET_NAME}/results/" ./results --recursive
        ls -R results

    - name: Analyze
      run: |
        pip install pandas matplotlib
        python analysis/analyze_results.py
